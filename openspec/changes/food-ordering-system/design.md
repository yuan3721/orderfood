## Context

这是一个全新的订餐系统项目，需要从零开始构建。系统服务于两类用户：
- **C 端用户**：公司员工或普通用户，需要每日浏览菜单、下单、支付
- **B 端商家**：餐厅管理员，需要管理菜谱、查看订单、进行运营管理

当前状态：无现有系统，需要完整构建三个项目。

约束条件：
- 小程序需符合微信小程序开发规范
- 需要对接微信支付
- 需要处理订单截止时间和库存控制

## Goals / Non-Goals

**Goals:**
- 构建可独立运行的 C 端微信小程序
- 构建可独立运行的 B 端微信小程序
- 构建支持两端的服务端 API
- 实现核心订餐流程：浏览菜单 → 下单 → 支付 → 查看订单
- 实现商家管理流程：上传菜谱 → 查看订单 → 管理通知

**Non-Goals:**
- 外卖配送功能（仅支持到店自取或内部配送）
- 多商家平台（初期仅支持单商家）
- 复杂的会员积分系统
- 评论评价功能

## Decisions

### Decision 1: 项目结构

采用 monorepo 结构，三个项目放在同一仓库：

```
orderfood/
├── apps/
│   ├── user-app/          # C端小程序 (Taro + React)
│   ├── merchant-app/      # B端小程序 (Taro + React)
│   └── server/            # 服务端 (Node.js + Koa)
├── packages/
│   └── shared/            # 共享类型定义和工具
└── ...
```

**理由**: 便于代码共享、统一依赖管理、原子化提交。

**替代方案**: 三个独立仓库 - 但会增加维护成本和代码同步难度。

### Decision 2: 小程序技术栈

选择 **UniApp + Vue 3** 作为小程序开发框架。

**理由**:
- 跨端能力强，支持微信/支付宝/H5/App 多端
- Vue 3 组合式 API，开发体验好
- 丰富的组件库生态 (uView, uni-ui)
- TypeScript 支持完善
- 社区活跃，文档完善

**替代方案**: 
- 微信原生开发 - 学习成本低但复用性差
- Taro + React - React 生态丰富但跨端兼容性稍弱

### Decision 3: 服务端技术栈

选择 **Node.js + Koa + TypeScript**。

**理由**:
- 与前端技术栈一致，代码共享方便
- 轻量灵活，适合快速开发
- TypeScript 提供类型安全

**替代方案**: Python FastAPI - 性能好但前后端技术栈不统一

### Decision 4: 数据库

选择 **PostgreSQL** + **Prisma ORM**。

**理由**:
- PostgreSQL 功能丰富，支持 JSON 类型
- Prisma 提供类型安全的数据库访问
- 迁移管理方便

### Decision 5: 文件存储

使用 **腾讯云 COS** 存储图片。

**理由**: 与微信生态集成好，SDK 支持完善。

### Decision 6: API 设计

采用 RESTful API 设计，使用 JSON 格式传输数据。

API 版本：`/api/v1/`

认证方式：JWT Token（基于微信登录获取的 openid 生成）

## Risks / Trade-offs

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 微信支付接入复杂 | 支付功能延期 | 初期可使用模拟支付，后期对接真实支付 |
| 库存并发问题 | 超卖 | 使用数据库乐观锁或 Redis 分布式锁 |
| 截止时间处理 | 用户体验差 | 前端倒计时 + 后端双重校验 |
| 小程序审核 | 上线延期 | 遵循微信规范，准备充分的审核材料 |

## Open Questions

- [ ] 是否需要支持支付宝支付？（初期建议仅微信支付）
- [ ] 菜品分类功能是否需要？（如：主食、配菜、饮品）
- [ ] 是否需要多语言支持？
